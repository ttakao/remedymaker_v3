# システム仕様
## 概要
このシステムはUSB接続されたレメディ生成機をコントロールするためのものである。
レメディ生成機はこのシステムから周波数リストの周波数（文字列）を送られると、その周波数を一定時間ごとに処理する。リストの周波数をすべて送ると「作成」終了とする。
この目的のために、以下の機能をもつ
- ユーザー認証によるログイン
- データをサーバーからすべてダウンロードする　（ダウンロード時に研修に出たデータはダウンロードされるが、出ていないものはダウンロードされない）
- ユーザーによる検索かグループ階層による絞り込み
- 周波数リストの特定と「生成」。周波数リストのデータをレメディ生成機に転送
- ユーザーはプライベートな周波数リストをもてる。こちらはサブグループは必要なく、単なる周波数リストである。
- 管理機能（ユーザーの作成、支払いの確認などの属性編集、ユーザーの削除）


## ログイン処理(A)
### A-1. ユーザーは別途、登録したメールアドレスでログインする。
ユーザの属性は以下のとおり。サーバーのmysqlデータベースに登録される。

テーブル名 users
- ID　unsigned_int auto increment 会員ID
- regist_date datetime 登録日
- update_date datetime 更新日
- name varchar 255 名前
- mail varchar 255 メールアドレス
- learning varchar 255 研修参加履歴　（参加した研修コードが登録される）
- paid bool 1 0/1 システム使用料の支払いの有無(1=支払いあり）
- challenge varchar 255 ランダムパスワード
- memo text 備考欄

### A-2. パスキーを送る。
システムはメールアドレスに６桁の英数字のランダムな文字列を送り、同時にusersテーブルのchallengeにMD5で暗号化して書き込む
update_dateも更新する。

### A-3. システムはメールアドレスと、パスキー入力のフォームを表示する

### A-4. ユーザーはメールを確認し、パスキー文字列を入力する。

### A-5. 認証処理
システムはusersテーブルのupdaate_dateと現在時間を比べ、5分以内ならば、入力されたパスキーをMD5に暗号化し、challengeに登録されている値と比較する。同じならば正しいので、測定システム（B)を呼び出す。正しくない場合、最初の画面に戻る

### A-6. COOKIE処理
メールアドレスはキーとなるのでCOOKIEに保管する

# データ検索処理(B)
## 画面
画面がには次のフィールドがある。

- シリアル接続するポート名　SELECTリスト
- ひとつの周波数を継続する時間(秒）テキスト
- 文字列検索窓　テキスト　と　検索ボタン
-　レメディグループ名リスト表示　（スクローラブル・テーブル）
- レメディサブグループ名リスト表示 (スクローラブル・テーブル)
- レメディ周波数リスト表示 (スクローラブル・テーブル）
- 処理するレメディ周波数リスト表示（テキスト）　と　「書き込み」「中止」というラベルがついたボタン

  
目的はユーザーの指示、グループ階層を使ってレメディ周波数のリストを絞り込むか、文字列検索にしたがい、周波数リストをテーブルで表示すること

## データ構造
データは以下のテーブルに入っている

** 周波数リスト　テーブル名 frequencies ++
- ID unsigned_int 周波数ID
- SID unsigned_int サブグループID
- jname varchar 255 日本語名称
- ename varchar 255 英語名称
- flist varchar 1024 周波数リスト

** 周波数グループ　テーブル名 groups **
- ID unsigned_int グループ名のID
- gname varchar 255 グループ名
- leaningID varchar 10  属する研修ID

** 周波数サブグループ　テーブル名 subgroups **
- ID unsigned_int サブグループ名のid
- gid unsined_int 親のグループ名のid
- sname varchar 255 サブグループ名


## グループ階層による検索 (B)
### B-1. グループリスト表示
それぞれ、グループ　サブグループ　周波数リストである
最初はなんの指定もないのでグループだけをダウンロードする。この時、ダウンロードされるグループは研修IDのないもの、ユーザーが研修参加履歴に登録されたIDであるものだけ。

### B-2.  サブグループリスト表示
グループを指定されたら、属しているサブグループを検索してサブグループ欄に表示する。

### B-3. 周波数リスト表示
サブグループを指定されたら、属している周波数リストを表示する。

## 文字列検索
### C-1. 文字列検索窓に文字が入力されていて、「検索」ボタンがおされたら、`frequenciesのjnameとenameを検索する。
該当するレコードを周波数リスト表示欄に表示する

## データ転送処理(D)

### D-1. リスト転送処理
周波数リストのエントリーがクリックされたら、「処理する周波数リスト」に周波数リスト（データベーステーブルのflist)のみを書き出す。

### D-2. シリアル通信 
「書き込み」ボタンが押されたら、シリアルポートのオープンを試みる。シリアルポートの欄がブランク、もしくはオープンに失敗したらエラーダイアログを出す。
### D-3. 周波数送出開始
オープンが成功したら、周波数リストは,区切りなので順次周波数数値を取り出してシリアルでSENDし、「ひとつの周波数を継続する時間」秒、待つ。
### D-4.　周波数送出終了
リストの最後までD-3を繰り返し、すべての周波数の早出が終わったら、シリアルポートをクローズし「終了」ダイアログを出す。
なお、[中止」ボタンを押されたら、データ転送処理をやめて、シリアルポートをクローズする

## カスタムデータ処理(E)
ユーザーが周波数リストを登録、編集、削除できる。指定した行で「生成」ボタンを押すと、データ転送処理が始まる。


