# システム仕様書：レメディ生成機コントロールシステム (Version 3.0)

## 1. システム概要
本システムは、USB接続されたレメディ生成機をブラウザから直接制御するためのWebアプリケーションである。
Windowsアプリ（Visual Basic等）からの脱却を図り、ChromeOS (Chromebook)、Windows、macOSなど、Google Chromeブラウザが動作するあらゆる環境で利用可能とする。

### 1-1. 基本方針
- **脱フレームワーク**: ReactやVue等の外部ライブラリに依存せず、素のJavaScript (Vanilla JS) で構築し、長期的な保守性を確保する。
- **Web Serial APIの採用**: ブラウザから直接USBシリアルポートを制御する。
- **サーバー構成**: 一般的なレンタルサーバー（PHP + MySQL）で動作し、データのやり取りはJSON形式で行う。
- **ハードウェア互換性**: 既存の「周波数送信 → 指定時間待機」という通信シーケンスを完全に維持する。

---

## 2. データベース設計 (MySQL)

### 2-1. ユーザー管理 (users)
| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| id | INT AI PK | 会員ID |
| regist_date | DATETIME | 登録日 |
| update_date | DATETIME | 更新日（パスキー発行時等） |
| name | VARCHAR(255) | 氏名 |
| email | VARCHAR(255) | メールアドレス（ログインID / ユニーク） |
| paid | TINYINT(1) | 支払い済みフラグ (0:未払, 1:支払済) |
| passkey_hash | VARCHAR(255) | 6桁パスキーのハッシュ値 |
| memo | TEXT | 備考 |

### 2-2. 研修履歴 (user_learning)
ユーザーが受講した研修コードを管理する。
| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| user_id | INT | users.id と紐付け |
| learning_id | VARCHAR(50) | 研修コード |

### 2-3. 周波数データ (groups / subgroups / frequencies)
- **groups**: `id`, `gname`, `learning_id` (空の場合は全公開)
- **subgroups**: `id`, `gid` (親グループID), `sname`
- **frequencies**: `id`, `sid` (サブグループID), `jname`, `ename`, `flist` (カンマ区切り周波数文字列)

### 2-4. ユーザーカスタムデータ (user_custom_frequencies)
| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| id | INT AI PK | カスタムデータID |
| user_id | INT | users.id と紐付け |
| name | VARCHAR(255) | リスト名称 |
| flist | TEXT | 周波数リスト（カンマ区切り） |

---

## 3. 認証処理 (A)

### A-1. ログインフロー
1. ユーザーはメールアドレスを入力し「パスキー送信」ボタンを押す。
2. サーバー（PHP）は6桁の英数字ランダム文字列を生成し、メールで送信。同時に `password_hash()` でハッシュ化して `users.passkey_hash` に保存し、`update_date` を更新する。
3. 画面にパスキー入力フォームを表示。
4. ユーザーがパスキーを入力。

### A-2. 認証判定
1. `update_date` から5分以内であることを確認。
2. 入力されたパスキーを `password_verify()` で照合。
3. 一致した場合、PHPセッションを開始し、認証済みCookieを発行する。

---

## 4. データ検索・表示処理 (B/C)

### B-1. 初期ロード
- ログイン成功後、`index.html` はサーバーから以下のデータをJSONで取得し、ブラウザのメモリ上に保持する。
    - ユーザーが閲覧権限を持つ（研修IDが一致する、または空の）グループ・サブグループ・周波数リスト。
    - ユーザー自身のカスタムリスト。

### B-2. 画面構成 (SPA形式)
- **シリアル設定**: ポート選択ボタン、継続時間（秒）入力欄。
- **検索・抽出**: 
    - グループリスト（スクローラブル・テーブル）
    - サブグループリスト（スクローラブル・テーブル）
    - 周波数リスト（スクローラブル・テーブル）
    - 文字列検索窓（jname, enameをリアルタイムフィルタリング）
- **実行エリア**: 
    - 「処理する周波数リスト」表示エリア（テキスト）
    - 「書き込み（開始）」ボタン
    - 「中止」ボタン

---

## 5. データ転送処理 (D)

### D-1. シリアル通信の確立
1. 「ポート選択」ボタン押下時、`navigator.serial.requestPort()` を呼び出し、ユーザーにデバイスを選択させる。
2. 指定のボーレート（既存仕様に準拠）でポートをオープンする。

### D-2. 周波数送出シーケンス（既存ハードウェア仕様）
「書き込み」ボタンが押された際の処理：
1. 処理する周波数リスト（カンマ区切り）を配列に変換。
2. ループ処理を開始：
    - 配列から1つの周波数文字列を取り出す。
    - シリアルポートへ文字列として送信。
    - `await new Promise(resolve => setTimeout(resolve, interval * 1000))` により、指定秒数待機。
    - 次の周波数へ。
3. 全リスト終了後、ポートをクローズし「終了」ダイアログを表示。

### D-3. 中止処理
- 「中止」ボタンが押された場合、ループ内のフラグを書き換え、即座に送信を停止し、ポートをクローズする。

---

## 6. カスタムデータ処理 (E)
- ユーザーは自分専用の周波数リストを登録・編集・削除できる。
- 保存先は `user_custom_frequencies` テーブル。
- 登録したデータは、通常の周波数リストと同様に選択して「生成（転送）」が可能。

---

## 7. 管理機能 (F)
管理者権限を持つユーザーのみがアクセス可能な管理画面。
- ユーザーの新規作成・編集（名前、メール、研修履歴、支払いフラグ）。
- 支払い確認（paidフラグのON/OFF）。
- ユーザーの削除。

---

## 8. 技術仕様詳細

### 8-1. フロントエンド
- **HTML/CSS**: `index.html` 1ファイル、または最小限の構成。
- **JavaScript**: Vanilla JS (ES6+)。`fetch` APIによる非同期通信。Web Serial APIによるハードウェア制御。

### 8-2. バックエンド
- **言語**: PHP 7.4 / 8.x
- **API**: `api.php` 等のエンドポイントを用意し、`action` パラメータによって処理を分岐。
- **セキュリティ**: 
    - SQLインジェクション対策（プリペアドステートメント）。
    - セッションによるアクセス制御。
    - パスワード（パスキー）の適切なハッシュ化。

### 8-3. 動作環境
- **クライアント**: Google Chrome (Version 89以降)
- **OS**: ChromeOS, Windows 10/11, macOS, Linux
- **サーバー**: PHP/MySQLが動作する一般的なレンタルサーバー（SSL必須）

---

## 9. 特記事項
- 本システムは、将来的なWindowsの仕様変更やOSの衰退に左右されないよう、Web標準技術のみで構成されている。
- ハードウェアとの通信部分は、既存のVB版のロジック（送信→待機）をJavaScriptの非同期処理で忠実に再現する。
